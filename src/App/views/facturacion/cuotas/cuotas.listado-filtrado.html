<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'parts/head.view.html' %}
</head>
<body>
    {% include "parts/modulos.view.html" %}

    <section class="container_cuotas">
        <div class="container mt-5">
            <h1 class="mb-4">Descuento de Haberes</h1>

            <form method="get" class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="fechaDesde" class="form-label">Desde</label>
                    <input type="date" id="fechaDesde" name="desde" class="form-control" value="{{ desde }}">
                </div>
                <div class="col-md-4">
                    <label for="fechaHasta" class="form-label">Hasta</label>
                    <input type="date" id="fechaHasta" name="hasta" class="form-control" value="{{ hasta }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" id="btnFiltrarAgrupado" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </form>

            <div id="mensajeInicial" class="alert alert-info">
                Debe seleccionar un periodo y presionar en <strong>Filtrar</strong> para ver los resultados.
            </div>

            <div id="accionesDescuento" class="d-none mb-4">
                <button class="btn btn-success me-2" id="btnAplicarDescuento">âœ… Realizar Descuento de Haberes</button>
            </div>

            <div id="mensajeExito" class="alert alert-success d-none">
                âœ… Descuento de haberes aplicado correctamente.
                <button class="btn btn-outline-primary btn-sm ms-3 d-none" id="btnExportarTxt">ðŸ“„ Exportar Reporte TXT</button>
            </div>

            <div id="tablaCuotasAgrupadas" class="mt-4"></div>
        </div>
    </section>

    {% include 'parts/footer.view.html' %}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const btnFiltrar = document.getElementById('btnFiltrarAgrupado');
        const btnAplicar = document.getElementById('btnAplicarDescuento');
        const btnExportar = document.getElementById('btnExportarTxt');

        const inputDesde = document.getElementById('fechaDesde');
        const inputHasta = document.getElementById('fechaHasta');
        const contenedor = document.getElementById('tablaCuotasAgrupadas');
        const acciones = document.getElementById('accionesDescuento');
        const mensajeExito = document.getElementById('mensajeExito');

        let periodoDesde = '';
        let periodoHasta = '';

        btnFiltrar.addEventListener('click', function () {
            const desde = inputDesde.value; // recibo parametro desde
            const hasta = inputHasta.value; // recibo parametro hasta

            if (!desde || !hasta) { // controlo que no sean vacios sino cargo un alert, tengo que corregir esta parte con un modal
                alert('SeleccionÃ¡ un periodo vÃ¡lido.');
                return;
            }

            periodoDesde = desde;
            periodoHasta = hasta;

            fetch('/facturacion/cuotas/listado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ desde, hasta })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) throw new Error('Error al agrupar cuotas');

                document.getElementById('mensajeInicial').classList.add('d-none');
                mensajeExito.classList.add('d-none');
                acciones.classList.remove('d-none');
                btnExportar.classList.add('d-none');

                contenedor.innerHTML = '';

                if (data.grupos.length === 0) {
                    contenedor.innerHTML = '<div class="alert alert-warning">No se encontraron cuotas para el periodo indicado.</div>';
                    return;
                }

                console.log("Data grupos: ");
                console.log("Datos Agente: ");
                console.table(data.grupos);

                console.log("Detalle cuotas: "); 
                console.table(data.grupos[0].cuotas);


                data.grupos.forEach(grupo => {
                    let detalleCuotas = [];
                    const agenteTitulo = document.createElement('h5');
                    agenteTitulo.innerHTML = `Agente: <a href="/facturacion/agente/ver?agente_id=${grupo.agente_id}" target="_blank" class="text-decoration-none">${grupo.agente}</a>`;
                    contenedor.appendChild(agenteTitulo);
                    
                    const cuotasFiltradas = grupo.cuotas.filter(c => c.estado !== 'pagada');
                    if (cuotasFiltradas.length === 0) return;

                    const tabla = document.createElement('table');
                    tabla.classList.add('table', 'table-bordered', 'mb-4');
                    let filas = '';
                    let totalPagado = 0;
                    let totalAcumulado = 0;
                    let excedeLimite = false;

                    filas += `
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nro. Factura</th>
                                <th>Nro. Cuota</th>
                                <th>Monto</th>
                                <th>Vencimiento</th>
                                <th>Periodo</th>
                                <th>Pagado</th>
                                <th>Reprogramado</th>
                                <th>A descontar</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                    cuotasFiltradas.forEach(cuota => {
                        const montoTotal = parseFloat(cuota.monto);
                        const pagadoAnterior = parseFloat(cuota.monto_pagado || 0);
                        const reproAnterior = parseFloat(cuota.monto_reprogramado || 0);
                    
                        const pendiente = reproAnterior > 0 ? reproAnterior : montoTotal - pagadoAnterior;
                    
                        let pagado = 0;
                        let reprogramado = pendiente;
                    
                        if (!excedeLimite && totalAcumulado + pendiente <= 100000) {
                            pagado = pendiente;
                            reprogramado = 0;
                            totalAcumulado += pendiente;
                            detalleCuotas.push(`${pagado < montoTotal ? 'parcial: ' : ''}$${pagado.toFixed(2)} de cuota #${cuota.id}`);
                        } else if (!excedeLimite && totalAcumulado < 100000) {
                            pagado = 100000 - totalAcumulado;
                            reprogramado = pendiente - pagado;
                            totalAcumulado = 100000;
                            excedeLimite = true;
                            cuota.estado = 'a-reprogramar';
                            detalleCuotas.push(`parcial: $${pagado.toFixed(2)} de cuota #${cuota.id}`);
                        } else {
                            // Sin margen, todo reprogramado
                            pagado = 0;
                            reprogramado = pendiente;
                            cuota.estado = 'a-reprogramar';
                        }
                    
                        totalPagado += pagado;
                    
                        filas += `
                            <tr data-cuota-id="${cuota.id}" data-estado="${cuota.estado}">
                                <td>${cuota.id}</td>
                                <td>${cuota.nro_factura}</td>
                                <td>${cuota.nro_cuota}</td>
                                <td>$${montoTotal.toFixed(2)}</td>
                                <td>${cuota.fecha_vencimiento}</td>
                                <td>${cuota.periodo ?? 'Sin reprogramar'}</td>
                                <td>$${(pagadoAnterior + pagado).toFixed(2)}</td>
                                <td>$${reprogramado.toFixed(2)}</td>
                                <td>$${pagado.toFixed(2)}</td>
                                <td><span class="badge ${cuota.estado === 'a-reprogramar' ? 'bg-danger' : cuota.estado === 'pendiente' ? 'bg-warning text-dark' : 'bg-success'}">${cuota.estado}</span></td>
                            </tr>`;
                    });

                    const detalleTexto = detalleCuotas.length > 0 
                        ? `<em>(Ej: ${detalleCuotas.join(' + ')})</em>` 
                        : '';
                    console.log("Detalle cuotas:", detalleTexto);

                    filas += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="9"><strong>Total a descontar:</strong></td>
                                <td><strong>$${totalPagado.toFixed(2)}</strong></td>
                            </tr>
                            <tr>
                                <td colspan="10" class="text-muted small">${detalleTexto}</td>
                            </tr>
                        </tfoot>
                    `;

                    tabla.innerHTML = filas;
                    contenedor.appendChild(tabla);
                });
            })
            .catch(error => {
                console.error(error);
                contenedor.innerHTML = '<div class="alert alert-danger">OcurriÃ³ un error al cargar el reporte.</div>';
            });
        });


        btnAplicar.addEventListener('click', function () {
            const agenteLink = document.querySelector('a[href*="agente_id="]');
            const agenteId = agenteLink ? new URLSearchParams(agenteLink.href.split('?')[1]).get('agente_id') : null;
        
            if (!agenteId) {
                alert('No se encontrÃ³ el agente seleccionado.');
                return;
            }
        
            fetch('/facturacion/cuotas/aplicar-descuento', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    desde: periodoDesde,
                    hasta: periodoHasta,
                    agente_id: agenteId
                })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) throw new Error('Error al aplicar descuento');
        
                mensajeExito.classList.remove('d-none');
                acciones.classList.add('d-none');
                btnExportar.classList.remove('d-none');
        
                contenedor.innerHTML = '';
        
                let totalPagado = 0;
                const tabla = document.createElement('table');
                tabla.classList.add('table', 'table-bordered', 'mt-4');
        
                let filas = `
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nro. Factura</th>
                            <th>Nro. Cuota</th>
                            <th>Monto</th>
                            <th>Vencimiento</th>
                            <th>Periodo</th>
                            <th>Pagado</th>
                            <th>Reprogramado</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
        
                data.cuotas.forEach(c => {
                    const pagado = parseFloat(c.monto_pagado);
                    const reprogramado = parseFloat(c.monto_reprogramado);
                    const total = parseFloat(c.monto);
                    totalPagado += pagado;
        
                    filas += `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.nro_factura}</td>
                            <td>${c.nro_cuota}</td>
                            <td>$${total.toFixed(2)}</td>
                            <td>${c.fecha_vencimiento}</td>
                            <td>${c.periodo ?? 'Fecha inicial'}</td>
                            <td>$${pagado.toFixed(2)}</td>
                            <td>$${reprogramado.toFixed(2)}</td>
                            <td>
                                <span class="badge ${c.estado === 'pagada' ? 'bg-success' : c.estado === 'reprogramada' ? 'bg-danger' : 'bg-warning text-dark'}">
                                    ${c.estado}
                                </span>
                            </td>
                        </tr>
                    `;
                });
        
                filas += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="8"><strong>Total pagado:</strong></td>
                            <td><strong>$${totalPagado.toFixed(2)}</strong></td>
                        </tr>
                    </tfoot>
                `;
        
                tabla.innerHTML = filas;
                contenedor.appendChild(tabla);
            })
            .catch(err => {
                console.error(err);
                alert('OcurriÃ³ un error al aplicar el descuento.');
            });
        });
        
    });
    </script>
</body>
</html>

