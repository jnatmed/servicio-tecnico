<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'parts/head.view.html' %}
</head>
<body>
    {% include "parts/modulos.view.html" %}

    <section class="container_cuotas">
        <div class="container mt-5">
            <h1 class="mb-4">Descuento de Haberes</h1>

            <!-- Filtro por rango de fechas -->
            <form method="get" class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="fechaDesde" class="form-label">Desde</label>
                    <input type="date" id="fechaDesde" name="desde" class="form-control" value="{{ desde }}">
                </div>
                <div class="col-md-4">
                    <label for="fechaHasta" class="form-label">Hasta</label>
                    <input type="date" id="fechaHasta" name="hasta" class="form-control" value="{{ hasta }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" id="btnFiltrarAgrupado" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </form>

            <div id="mensajeInicial" class="alert alert-info">
                Debe seleccionar un período y presionar en <strong>Filtrar</strong> para ver los resultados.
            </div>

            <!-- Resultados agrupados -->
            <div id="tablaCuotasAgrupadas" class="mt-4"></div>
        </div>
    </section>

    {% include 'parts/footer.view.html' %}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const btnFiltrar = document.getElementById('btnFiltrarAgrupado');
        const inputDesde = document.getElementById('fechaDesde');
        const inputHasta = document.getElementById('fechaHasta');
        const contenedor = document.getElementById('tablaCuotasAgrupadas');

        btnFiltrar.addEventListener('click', function () {
            const desde = inputDesde.value;
            const hasta = inputHasta.value;

            if (!desde || !hasta) {
                alert('Seleccioná un período válido.');
                return;
            }

            fetch('/facturacion/cuotas/listado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ desde, hasta })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) throw new Error('Error al agrupar cuotas');
                document.getElementById('mensajeInicial').classList.add('d-none');

                contenedor.innerHTML = '';

                if (data.grupos.length === 0) {
                    contenedor.innerHTML = '<div class="alert alert-warning">No se encontraron cuotas para el período indicado.</div>';
                    return;
                }

                data.grupos.forEach(grupo => {
                    const agenteTitulo = document.createElement('h5');
                    agenteTitulo.textContent = `Agente: ${grupo.agente}`;
                    contenedor.appendChild(agenteTitulo);

                    const tabla = document.createElement('table');
                    tabla.classList.add('table', 'table-bordered', 'mb-4');
                    tabla.innerHTML = `
                        <thead>
                            <tr>
                                <th>Nro. Factura</th>
                                <th>Nro. Cuota</th>
                                <th>Monto</th>
                                <th>Vencimiento</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${grupo.cuotas.map(c => `
                                <tr>
                                    <td>${c.nro_factura}</td>
                                    <td>${c.nro_cuota}</td>
                                    <td>$${parseFloat(c.monto).toFixed(2)}</td>
                                    <td>${c.fecha_vencimiento}</td>
                                    <td><span class="badge ${c.estado === 'pagada' ? 'bg-success' : 'bg-warning text-dark'}">${c.estado}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4"><strong>Total a descontar:</strong></td>
                                <td><strong>$${parseFloat(grupo.total).toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    `;
                    contenedor.appendChild(tabla);
                });
            })
            .catch(error => {
                console.error(error);
                contenedor.innerHTML = '<div class="alert alert-danger">Ocurrió un error al cargar el reporte.</div>';
            });
        });
    });
    </script>
</body>
</html>